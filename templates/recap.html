{% extends "base.html" %}

{% block title %}Live Vote Count{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4 fw-bold">Live Vote Count</h1>

    <div class="text-center mb-4">
        <button class="btn btn-outline-primary me-2" onclick="showChart('senat')">Ketua Senat</button>
        <button class="btn btn-outline-secondary" onclick="showChart('demus')">Ketua Dewan Musyawarah Taruna</button>
    </div>

    <div class="recap-section p-4 shadow-sm rounded bg-white">
        <h2 class="text-center mb-4" id="chart-title">Ketua Senat <span id="voteCount" class="text-muted">(Votes: 0)</span></h2>
        <canvas id="voteChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let voteChart;
    let currentChart = 'senat';
    let voteCount = 0;
    let voteData = {};
    let eventSource;

    function fetchVoteCounts(chartType) {
        if (eventSource) {
            eventSource.close();
        }
        eventSource = new EventSource(`/live_count?type=${chartType}`);

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === currentChart) {
                updateChart(data.candidate);
                voteCount++;
                document.getElementById('voteCount').textContent = `(Votes: ${voteCount})`;
            }
        };
        eventSource.onerror = function() {
            eventSource.close();
        };
    }

    function updateChart(label) {
        if (!voteData[label]) {
            voteData[label] = 1;
        } else {
            voteData[label] += 1;
        }

        const totalVotes = Object.values(voteData).reduce((a, b) => a + b, 0);
        const percentages = Object.keys(voteData).map(key => {
            return Math.round((voteData[key] / totalVotes) * 100);
        });

        if (!voteChart) {
            const ctx = document.getElementById('voteChart').getContext('2d');
            voteChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(voteData),
                    datasets: [{
                        label: 'Votes (%)',
                        data: percentages,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    animation: {
                        duration: 500
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                precision: 0,
                                callback: function(value) {
                                    return value + "%";
                                }
                            }
                        }
                    }
                }
            });
        } else {
            voteChart.data.labels = Object.keys(voteData);
            voteChart.data.datasets[0].data = percentages;
            voteChart.update();
        }

        highlightWinner();
    }

    function highlightWinner() {
        const maxVotes = Math.max(...Object.values(voteData));
        const totalVotes = Object.values(voteData).reduce((a, b) => a + b, 0);
        const threshold = totalVotes / 2;
        if (maxVotes > threshold) {
            document.getElementById('voteChart').classList.add('winner-effect');
        } else {
            document.getElementById('voteChart').classList.remove('winner-effect');
        }
    }

    function resetChart() {
        if (voteChart) {
            voteChart.destroy();
            voteChart = null;
        }
        voteData = {};
    }

    function showChart(chartType) {
        currentChart = chartType;
        document.getElementById('chart-title').innerHTML = (chartType === 'senat' ? 'Ketua Senat' : 'Ketua Dewan Musyawarah Taruna') +
            ' <span id="voteCount" class="text-muted">(Votes: 0)</span>';
        voteCount = 0;
        resetChart();
        fetchVoteCounts(chartType);
    }

    document.addEventListener("DOMContentLoaded", function () {
        showChart('senat');
    });
</script>

<style>
    body {
        background-color: #f8f9fa;
    }

    .recap-section {
        max-width: 800px;
        margin: auto;
        background-color: #fff;
        border-radius: 10px;
    }

    .btn {
        transition: all 0.3s ease-in-out;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
    }

    .winner-effect {
        animation: fireEffect 1s infinite alternate;
    }

    @keyframes fireEffect {
        from { filter: drop-shadow(0px 0px 5px red); }
        to { filter: drop-shadow(0px 0px 10px orange); }
    }
</style>
{% endblock %}

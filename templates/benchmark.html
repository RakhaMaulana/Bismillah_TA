{% extends "base.html" %}

{% block title %}Performance Benchmark - Crypvote{% endblock %}

{% block content %}
<div class="benchmark-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-11">
                <div class="benchmark-card shadow-lg border-0 rounded-4 p-4">
                    <!-- Header Section -->
                    <div class="text-center mb-5">
                        <div class="benchmark-icon mb-3">
                            <i class="fas fa-rocket fa-3x text-primary"></i>
                        </div>
                        <h1 class="fw-bold text-dark mb-2">Performance Benchmark</h1>
                        <p class="text-muted lead">E-Voting System Performance Analysis vs zkVoting Research</p>
                    </div>

                    <!-- Benchmark Info Cards -->
                    <div class="row mb-5">
                        <div class="col-lg-8">
                            <div class="info-card h-100">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-chart-line me-2"></i>
                                    Benchmark Process
                                </h5>
                                <div class="process-steps">
                                    <div class="step-item">
                                        <div class="step-icon">
                                            <i class="fas fa-vote-yea"></i>
                                        </div>
                                        <div class="step-content">
                                            <strong>Vote Generation</strong>
                                            <p class="mb-0 text-muted">Create actual ballots with blind signatures</p>
                                        </div>
                                    </div>
                                    <div class="step-item">
                                        <div class="step-icon">
                                            <i class="fas fa-calculator"></i>
                                        </div>
                                        <div class="step-content">
                                            <strong>Tabulation</strong>
                                            <p class="mb-0 text-muted">Count all generated votes efficiently</p>
                                        </div>
                                    </div>
                                    <div class="step-item">
                                        <div class="step-icon">
                                            <i class="fas fa-shield-alt"></i>
                                        </div>
                                        <div class="step-content">
                                            <strong>Verification</strong>
                                            <p class="mb-0 text-muted">Verify signature authenticity and integrity</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="research-card h-100">
                                <h6 class="card-title mb-3">
                                    <i class="fas fa-university me-2"></i>
                                    zkVoting Research Baseline
                                </h6>
                                <div class="research-metrics">
                                    <div class="metric-item">
                                        <span class="metric-label">Ballot Casting</span>
                                        <span class="metric-value">2,300ms</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">Tally Time</span>
                                        <span class="metric-value">3.9ms/ballot</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">Complexity</span>
                                        <span class="metric-value">O(n)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Benchmark Configuration -->
                    <div class="config-section mb-5">
                        <h5 class="section-title mb-4">
                            <i class="fas fa-cogs me-2"></i>
                            Benchmark Configuration
                        </h5>

                        <form id="benchmarkForm" method="POST" class="benchmark-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                            <div class="row align-items-end">
                                <div class="col-lg-8">
                                    <div class="form-floating mb-3">
                                        <input type="number"
                                               class="form-control form-control-lg"
                                               id="votingIterations"
                                               name="voting_iterations"
                                               value="50"
                                               min="10"
                                               max="1024"
                                               required>
                                        <label for="votingIterations">
                                            <i class="fas fa-list-ol me-2"></i>
                                            Number of Votes to Generate
                                        </label>
                                    </div>
                                    <div class="form-help">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Range: 10-1024 votes.
                                            <strong>Quick test:</strong> 50-200 votes |
                                            <strong>Full benchmark:</strong> 500-1024 votes
                                        </small>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="d-grid">
                                        <button type="submit"
                                                class="btn btn-primary btn-lg py-3 fw-semibold"
                                                id="runBtn">
                                            <i class="fas fa-rocket me-2"></i>
                                            Run Benchmark
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Progress Section -->
                    <div id="loadingIndicator" class="progress-section d-none">
                        <div class="text-center mb-4">
                            <div class="loading-spinner mb-3">
                                <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <h4 id="loadingText" class="mb-3">Initializing benchmark...</h4>

                            <!-- Main Progress Bar -->
                            <div class="main-progress mb-4">
                                <div class="progress" style="height: 30px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                         role="progressbar" style="width: 0%" id="progressBar">
                                        <span id="progressText" class="fw-semibold">0%</span>
                                    </div>
                                </div>
                                <div class="progress-info mt-2">
                                    <small class="text-muted">
                                        <span id="timeEstimate">Estimated time: Calculating...</span> •
                                        <span id="elapsedTime">Elapsed: 0s</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Steps -->
                        <div class="row">
                            <div class="col-lg-4 mb-3">
                                <div class="progress-card" id="generationCard">
                                    <div class="progress-header">
                                        <i class="fas fa-vote-yea fa-2x text-primary mb-2"></i>
                                        <h6 class="card-title">Vote Generation</h6>
                                    </div>
                                    <div class="progress-body">
                                        <p class="progress-status" id="generationStatus">Waiting...</p>
                                        <div class="progress">
                                            <div class="progress-bar bg-primary" id="generationProgress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 mb-3">
                                <div class="progress-card" id="tabulationCard">
                                    <div class="progress-header">
                                        <i class="fas fa-calculator fa-2x text-warning mb-2"></i>
                                        <h6 class="card-title">Tabulation</h6>
                                    </div>
                                    <div class="progress-body">
                                        <p class="progress-status" id="tabulationStatus">Waiting...</p>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" id="tabulationProgress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 mb-3">
                                <div class="progress-card" id="verificationCard">
                                    <div class="progress-header">
                                        <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                                        <h6 class="card-title">Verification</h6>
                                    </div>
                                    <div class="progress-body">
                                        <p class="progress-status" id="verificationStatus">Waiting...</p>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" id="verificationProgress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

            <!-- Debug Information -->
            <div id="debugInfo" class="alert alert-info d-none">
                <h6>🔍 Debug Information</h6>
                <pre id="debugContent"></pre>
            </div>

                    <!-- Results Section -->
                    <div id="results" class="results-section d-none">
                        <div class="text-center mb-4">
                            <h2 class="fw-bold text-success mb-2">
                                <i class="fas fa-trophy me-2"></i>
                                Benchmark Results
                            </h2>
                            <p class="text-muted">Performance analysis complete</p>
                        </div>

                        <!-- Overall Performance Summary -->
                        <div class="summary-cards mb-5">
                            <div class="row">
                                <div class="col-lg-3 col-md-6 mb-3">
                                    <div class="summary-card">
                                        <div class="summary-icon">
                                            <i class="fas fa-vote-yea"></i>
                                        </div>
                                        <div class="summary-content">
                                            <h3 id="totalVotes">0</h3>
                                            <p>Total Votes</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-3">
                                    <div class="summary-card">
                                        <div class="summary-icon">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                        <div class="summary-content">
                                            <h3 id="totalTime">0ms</h3>
                                            <p>Total Time</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-3">
                                    <div class="summary-card">
                                        <div class="summary-icon">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                        <div class="summary-content">
                                            <h3 id="overallSpeedup">0x</h3>
                                            <p>vs zkVoting</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-3">
                                    <div class="summary-card">
                                        <div class="summary-icon">
                                            <i class="fas fa-star"></i>
                                        </div>
                                        <div class="summary-content">
                                            <h3 id="performanceRating">⭐</h3>
                                            <p>Rating</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vote Distribution -->
                        <div class="vote-distribution-section mb-5">
                            <h5 class="section-title mb-4">
                                <i class="fas fa-chart-pie me-2"></i>
                                Vote Distribution
                            </h5>
                            <div class="distribution-card">
                                <div id="voteDistribution" class="row">
                                    <!-- Vote counts akan diisi oleh JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Performance Metrics -->
                        <div class="detailed-results mb-5">
                            <h5 class="section-title mb-4">
                                <i class="fas fa-analytics me-2"></i>
                                Detailed Performance Metrics
                            </h5>
                            <div class="row">
                                <!-- Generation Results -->
                                <div class="col-lg-4 mb-4">
                                    <div class="metric-card generation">
                                        <div class="metric-header">
                                            <i class="fas fa-vote-yea fa-2x"></i>
                                            <h6>Vote Generation</h6>
                                        </div>
                                        <div class="metric-body">
                                            <div class="metric-item">
                                                <span class="metric-label">Generated Votes</span>
                                                <span class="metric-value" id="genVotes">0</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Generation Time</span>
                                                <span class="metric-value" id="genTime">0ms</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Time per Vote</span>
                                                <span class="metric-value" id="genAvgTime">0ms</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Votes per Second</span>
                                                <span class="metric-value" id="genThroughput">0</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Success Rate</span>
                                                <span class="metric-value" id="genSuccessRate">0%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabulation Results -->
                                <div class="col-lg-4 mb-4">
                                    <div class="metric-card tabulation">
                                        <div class="metric-header">
                                            <i class="fas fa-calculator fa-2x"></i>
                                            <h6>Tabulation</h6>
                                        </div>
                                        <div class="metric-body">
                                            <div class="metric-item">
                                                <span class="metric-label">Ballots Counted</span>
                                                <span class="metric-value" id="tabBallots">0</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Tabulation Time</span>
                                                <span class="metric-value" id="tabTime">0ms</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Time per Ballot</span>
                                                <span class="metric-value" id="tabPerBallot">0ms</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Ballots per Second</span>
                                                <span class="metric-value" id="tabThroughput">0</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">vs zkVoting</span>
                                                <span class="metric-value" id="tabSpeedup">0x</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Verification Results -->
                                <div class="col-lg-4 mb-4">
                                    <div class="metric-card verification">
                                        <div class="metric-header">
                                            <i class="fas fa-shield-alt fa-2x"></i>
                                            <h6>Verification</h6>
                                        </div>
                                        <div class="metric-body">
                                            <div class="metric-item">
                                                <span class="metric-label">Votes Verified</span>
                                                <span class="metric-value" id="verVotes">0</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Verification Time</span>
                                                <span class="metric-value" id="verTime">0ms</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Time per Vote</span>
                                                <span class="metric-value" id="verAvgTime">0ms</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Verifications/sec</span>
                                                <span class="metric-value" id="verThroughput">0</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Success Rate</span>
                                                <span class="metric-value" id="verSuccessRate">0%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Performance Comparison -->
                        <div class="comparison-section">
                            <h5 class="section-title mb-4">
                                <i class="fas fa-trophy me-2"></i>
                                Performance Comparison vs zkVoting Research
                            </h5>
                            <div class="comparison-card">
                                <div class="table-responsive">
                                    <table class="table table-modern">
                                        <thead>
                                            <tr>
                                                <th>Process</th>
                                                <th>Our System</th>
                                                <th>zkVoting Research</th>
                                                <th>Performance</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="fw-semibold">Ballot Casting</td>
                                                <td id="compGenTime">-</td>
                                                <td>2,300ms per ballot</td>
                                                <td id="compGenSpeedup" class="fw-semibold">-</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Tabulation</td>
                                                <td id="compTabTime">-</td>
                                                <td>3.9ms per ballot</td>
                                                <td id="compTabSpeedup" class="fw-semibold">-</td>
                                            </tr>
                                            <tr class="table-success">
                                                <td class="fw-bold">Overall E2E</td>
                                                <td id="compOverallTime" class="fw-semibold">-</td>
                                                <td class="fw-semibold">~2,300ms per vote</td>
                                                <td id="compOverallSpeedup" class="fw-bold">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div id="errorMessage" class="error-section d-none">
                        <div class="error-card">
                            <div class="error-icon">
                                <i class="fas fa-exclamation-triangle fa-3x"></i>
                            </div>
                            <div class="error-content">
                                <!-- Error content will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Debug Information -->
                    <div id="debugInfo" class="debug-section d-none">
                        <h6 class="debug-title">
                            <i class="fas fa-bug me-2"></i>
                            Debug Information
                        </h6>
                        <pre id="debugContent" class="debug-content"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
console.log('🔍 Benchmark script loaded');

// ✅ IMPROVED: More accurate progress tracking
let benchmarkStartTime = 0;
let progressInterval = null;

// Helper functions
function safeUpdateElement(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = value;
        console.log(`✅ Updated ${elementId}: ${value}`);
    } else {
        console.log(`❌ Element not found: ${elementId}`);
    }
}

function safeToggleClass(elementId, className, add = true) {
    const element = document.getElementById(elementId);
    if (element) {
        if (add) {
            element.classList.add(className);
        } else {
            element.classList.remove(className);
        }
    }
}

function getCSRFToken() {
    const tokenInput = document.querySelector('input[name="csrf_token"]');
    return tokenInput ? tokenInput.value : null;
}

function formatTimeInMs(timeInSeconds) {
    const timeInMs = timeInSeconds * 1000;
    if (timeInMs < 1) {
        return `${timeInMs.toFixed(3)}ms`;
    } else if (timeInMs < 10) {
        return `${timeInMs.toFixed(2)}ms`;
    } else if (timeInMs < 100) {
        return `${timeInMs.toFixed(1)}ms`;
    } else {
        return `${timeInMs.toFixed(0)}ms`;
    }
}

// ✅ IMPROVED: Better progress tracking that doesn't get stuck
function startProgressTracking(voteCount) {
    benchmarkStartTime = Date.now();
    let progress = 0;
    let currentStage = 'generation';
    let stageStartTime = Date.now();

    // ✅ IMPROVED: More realistic time estimation based on vote count
    const estimatedGenerationTime = Math.max(5, voteCount * 0.05); // ~0.05s per vote
    const estimatedTabulationTime = Math.max(2, voteCount * 0.01); // ~0.01s per vote
    const estimatedVerificationTime = Math.max(3, voteCount * 0.02); // ~0.02s per vote
    const estimatedTotalTime = estimatedGenerationTime + estimatedTabulationTime + estimatedVerificationTime;

    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const loadingText = document.getElementById('loadingText');
    const timeEstimate = document.getElementById('timeEstimate');
    const elapsedTime = document.getElementById('elapsedTime');

    if (timeEstimate) {
        timeEstimate.textContent = `Estimated time: ${estimatedTotalTime.toFixed(0)}s`;
    }

    progressInterval = setInterval(() => {
        const elapsed = (Date.now() - benchmarkStartTime) / 1000;
        const stageElapsed = (Date.now() - stageStartTime) / 1000;

        // Update elapsed time
        if (elapsedTime) {
            elapsedTime.textContent = `Elapsed: ${elapsed.toFixed(0)}s`;
        }

        // ✅ IMPROVED: Progress based on realistic timing and actual elapsed time
        if (currentStage === 'generation' && progress < 50) {
            // Progress based on estimated generation time vs actual elapsed time
            const expectedProgress = Math.min(50, (stageElapsed / estimatedGenerationTime) * 50);
            progress = Math.max(progress, expectedProgress);

            // Add small incremental progress to show activity
            progress += 0.5;

            if (progress >= 50 || stageElapsed >= estimatedGenerationTime * 1.2) {
                currentStage = 'tabulation';
                stageStartTime = Date.now();
                safeUpdateElement('generationStatus', '✅ Complete');
                document.getElementById('generationProgress')?.style.setProperty('width', '100%');
                safeUpdateElement('tabulationStatus', '⚡ Running...');
            } else {
                const genProgress = (progress / 50) * 100;
                document.getElementById('generationProgress')?.style.setProperty('width', `${genProgress}%`);
            }

            if (loadingText) {
                loadingText.textContent = `📝 Generating ${voteCount} votes with blind signatures...`;
            }

        } else if (currentStage === 'tabulation' && progress < 80) {
            // Progress based on estimated tabulation time vs actual elapsed time
            const expectedProgress = Math.min(30, (stageElapsed / estimatedTabulationTime) * 30);
            progress = Math.max(progress, 50 + expectedProgress);

            // Add small incremental progress
            progress += 1;

            if (progress >= 80 || stageElapsed >= estimatedTabulationTime * 1.2) {
                currentStage = 'verification';
                stageStartTime = Date.now();
                safeUpdateElement('tabulationStatus', '✅ Complete');
                document.getElementById('tabulationProgress')?.style.setProperty('width', '100%');
                safeUpdateElement('verificationStatus', '⚡ Running...');
            } else {
                const tabProgress = ((progress - 50) / 30) * 100;
                document.getElementById('tabulationProgress')?.style.setProperty('width', `${tabProgress}%`);
            }

            if (loadingText) {
                loadingText.textContent = '📊 Counting and tabulating votes...';
            }

        } else if (currentStage === 'verification' && progress < 98) {
            // Progress based on estimated verification time vs actual elapsed time
            const expectedProgress = Math.min(18, (stageElapsed / estimatedVerificationTime) * 18);
            progress = Math.max(progress, 80 + expectedProgress);

            // Add small incremental progress
            progress += 0.8;

            const verProgress = ((progress - 80) / 18) * 100;
            document.getElementById('verificationProgress')?.style.setProperty('width', `${verProgress}%`);

            if (loadingText) {
                loadingText.textContent = '🔓 Verifying signatures and finalizing...';
            }
        } else if (currentStage === 'verification' && progress >= 98) {
            // ✅ IMPROVED: Don't get stuck at 95%, allow completion
            if (loadingText) {
                loadingText.textContent = '⏳ Finalizing results and generating charts...';
            }

            // Slow increment toward 100% but don't stop completely
            progress += 0.1;
            progress = Math.min(progress, 99.5); // Stop just before 100%
        }

        // Update main progress bar
        if (progressBar) progressBar.style.width = Math.min(progress, 99.5) + '%';
        if (progressText) progressText.textContent = Math.min(progress, 99.5).toFixed(0) + '%';

        // ✅ IMPROVED: If taking too long, show "still processing" message
        if (elapsed > estimatedTotalTime * 1.5) {
            if (loadingText) {
                loadingText.textContent = '⏳ Processing large dataset - please wait...';
            }
            if (timeEstimate) {
                timeEstimate.textContent = `Processing time: ${elapsed.toFixed(0)}s (extended for ${voteCount} votes)`;
            }
        }

    }, 300); // Update every 300ms for smoother animation
}

function displayVoteDistribution(voteCounts) {
    const voteDistribution = document.getElementById('voteDistribution');
    if (!voteDistribution || !voteCounts) return;

    let html = '';
    let totalVotes = 0;

    // Hitung total votes
    for (const [candidate, count] of Object.entries(voteCounts)) {
        totalVotes += count;
    }

    // Generate cards untuk setiap kandidat
    for (const [candidate, count] of Object.entries(voteCounts)) {
        const percentage = totalVotes > 0 ? ((count / totalVotes) * 100).toFixed(1) : 0;
        html += `
            <div class="col-md-3 mb-2">
                <div class="card border-secondary">
                    <div class="card-body text-center py-2">
                        <h6 class="card-title mb-1">${candidate}</h6>
                        <span class="badge bg-primary">${count} votes</span>
                        <br>
                        <small class="text-muted">${percentage}%</small>
                    </div>
                </div>
            </div>
        `;
    }

    voteDistribution.innerHTML = html;
    console.log(`✅ Vote distribution displayed: ${totalVotes} total votes`);
}

// ✅ IMPROVED: Form submission with better validation
document.getElementById('benchmarkForm').addEventListener('submit', function(e) {
    e.preventDefault();
    console.log('🚀 Benchmark form submitted');

    const votingIterations = parseInt(document.getElementById('votingIterations').value);

    // ✅ VALIDATION: Check vote count limits
    if (isNaN(votingIterations) || votingIterations < 10 || votingIterations > 1024) {
        alert('⚠️ Please enter a valid vote count between 10 and 1024.');
        return;
    }

    // Show loading
    safeToggleClass('loadingIndicator', 'd-none', false);
    safeToggleClass('results', 'd-none', true);
    safeToggleClass('errorMessage', 'd-none', true);
    safeToggleClass('debugInfo', 'd-none', true);

    const runBtn = document.getElementById('runBtn');
    if (runBtn) runBtn.disabled = true;

    const csrfToken = getCSRFToken();

    console.log('📊 Benchmark parameters:', {
        votingIterations,
        csrfToken: csrfToken ? 'Present' : 'Missing'
    });

    // ✅ START IMPROVED PROGRESS TRACKING
    startProgressTracking(votingIterations);

    // Prepare form data
    const formData = new FormData();
    formData.append('voting_iterations', votingIterations);
    formData.append('iterations', '1'); // Single run
    formData.append('random_vote_count', '0'); // No random votes

    if (csrfToken) {
        formData.append('csrf_token', csrfToken);
    }

    // Send request
    fetch('/run_complete_benchmark', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // ✅ IMPROVED: Immediately complete progress when response received
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }

        // Complete all progress bars immediately
        const finalProgress = ['progressBar', 'generationProgress', 'tabulationProgress', 'verificationProgress'];
        finalProgress.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.style.width = '100%';
        });

        if (document.getElementById('progressText')) {
            document.getElementById('progressText').textContent = '100%';
        }

        safeUpdateElement('generationStatus', '✅ Complete');
        safeUpdateElement('tabulationStatus', '✅ Complete');
        safeUpdateElement('verificationStatus', '✅ Complete');

        // Update loading text
        const totalElapsed = (Date.now() - benchmarkStartTime) / 1000;
        safeUpdateElement('loadingText', `✅ Processing complete in ${totalElapsed.toFixed(1)}s - Loading results...`);

        console.log('📡 Response received:', response.status);

        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`HTTP ${response.status}: ${text.substring(0, 200)}...`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('✅ Benchmark data received:', data);

        // Debug vote distribution
        if (data.tabulation_results && data.tabulation_results.vote_counts) {
            console.log('🗳️ Vote Distribution:', data.tabulation_results.vote_counts);
            displayVoteDistribution(data.tabulation_results.vote_counts);
        }

        // Hide loading, show results
        safeToggleClass('loadingIndicator', 'd-none', true);
        safeToggleClass('results', 'd-none', false);

        console.log('📊 Populating results...');

        // Show completion time
        const totalElapsed = (Date.now() - benchmarkStartTime) / 1000;
        safeUpdateElement('loadingText', `✅ Benchmark completed in ${totalElapsed.toFixed(1)}s`);

        // Populate all results (your existing code)
        // Overall Performance
        if (data.overall_performance) {
            const totalTime = data.overall_performance.total_end_to_end_time || 0;
            const speedup = data.overall_performance.overall_speedup || 0;

            safeUpdateElement('totalVotes', votingIterations);
            safeUpdateElement('totalTime', formatTimeInMs(totalTime));
            safeUpdateElement('overallSpeedup', `${speedup.toFixed(1)}x`);
            safeUpdateElement('performanceRating', 'Complete');
        }

        // Generation results
        if (data.generation_results) {
            const actualVotes = data.generation_results.total_votes || 0;
            const genTime = data.generation_results.total_time || 0;
            const avgTime = data.generation_results.avg_time || 0;
            const throughput = data.generation_results.votes_per_second || 0;

            safeUpdateElement('genVotes', actualVotes);
            safeUpdateElement('genTime', formatTimeInMs(genTime));
            safeUpdateElement('genAvgTime', formatTimeInMs(avgTime));
            safeUpdateElement('genThroughput', `${throughput.toFixed(2)}`);
            safeUpdateElement('genSuccessRate', `${(data.generation_results.success_rate || 100).toFixed(1)}%`);
        }

        // Tabulation results
        if (data.tabulation_results) {
            const ballots = data.tabulation_results.total_ballots || 0;
            const time = data.tabulation_results.avg_time || 0;
            const timePerBallot = data.tabulation_results.avg_time_per_ballot || 0;
            const throughput = data.tabulation_results.ballots_per_second || 0;
            const speedup = data.tabulation_results.speedup_vs_zkvoting || 0;

            safeUpdateElement('tabBallots', ballots);
            safeUpdateElement('tabTime', formatTimeInMs(time));
            safeUpdateElement('tabPerBallot', formatTimeInMs(timePerBallot));
            safeUpdateElement('tabThroughput', `${throughput.toFixed(2)}`);
            safeUpdateElement('tabSpeedup', `${speedup.toFixed(2)}x`);
        }

        // Verification results
        if (data.decryption_results) {
            const verTime = data.decryption_results.total_time || 0;
            const verVotes = data.decryption_results.total_votes_verified || 0;
            const avgVerTime = data.decryption_results.avg_time || 0;
            const verThroughput = verVotes / verTime || 0;

            safeUpdateElement('verVotes', verVotes);
            safeUpdateElement('verTime', formatTimeInMs(verTime));
            safeUpdateElement('verAvgTime', formatTimeInMs(avgVerTime));
            safeUpdateElement('verThroughput', `${verThroughput.toFixed(2)}`);
            safeUpdateElement('verSuccessRate', `${(data.decryption_results.verification_success_rate || 100).toFixed(1)}%`);
        }

        // Comparison table with zkVoting
        if (data.generation_results && data.tabulation_results) {
            const genTime = data.generation_results.avg_time || 0;
            const tabTime = data.tabulation_results.avg_time_per_ballot || 0;
            const overallTime = genTime + tabTime;

            // zkVoting baseline: 2300ms casting, 3.9ms tally
            const genSpeedup = genTime > 0 ? 2.3 / genTime : 0;
            const tabSpeedup = tabTime > 0 ? 0.0039 / tabTime : 0;
            const overallSpeedup = overallTime > 0 ? 2.3 / overallTime : 0;

            safeUpdateElement('compGenTime', `${formatTimeInMs(genTime)} per vote`);
            safeUpdateElement('compGenSpeedup', `${genSpeedup.toFixed(2)}x`);

            safeUpdateElement('compTabTime', `${formatTimeInMs(tabTime)} per ballot`);
            safeUpdateElement('compTabSpeedup', `${tabSpeedup.toFixed(2)}x`);

            safeUpdateElement('compOverallTime', `${formatTimeInMs(overallTime)} per vote`);
            safeUpdateElement('compOverallSpeedup', `${overallSpeedup.toFixed(2)}x`);
        }

        if (runBtn) runBtn.disabled = false;
        console.log('✅ Benchmark results populated successfully');

        // Scroll to results
        setTimeout(() => {
            const resultsElement = document.getElementById('results');
            if (resultsElement) {
                resultsElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 500);
    })
    .catch(error => {
        console.error('❌ Benchmark error:', error);

        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }

        safeToggleClass('loadingIndicator', 'd-none', true);
        safeToggleClass('errorMessage', 'd-none', false);

        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.innerHTML = `
                <h5>❌ Benchmark Error</h5>
                <p><strong>Error:</strong> ${error.message}</p>
                <hr>
                <p><small>Check browser console (F12) for detailed error information.</small></p>
            `;
        }

        if (runBtn) runBtn.disabled = false;
    });
});

console.log('✅ Benchmark script initialized');
</script>

<style>
    /* Benchmark Container */
    .benchmark-container {
        min-height: 100vh;
        position: relative;
        overflow: hidden;
        padding: 2rem 0;
    }

    .benchmark-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.03)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.5;
    }

    /* Benchmark Card */
    .benchmark-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        position: relative;
        z-index: 2;
        margin: 2rem 0;
    }

    .benchmark-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 25px 50px rgba(0,0,0,0.1) !important;
    }

    /* Benchmark Icon */
    .benchmark-icon {
        animation: rocket 3s infinite;
    }

    @keyframes rocket {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        25% { transform: translateY(-5px) rotate(-2deg); }
        50% { transform: translateY(-8px) rotate(0deg); }
        75% { transform: translateY(-5px) rotate(2deg); }
    }

    /* Info Cards */
    .info-card {
        background: rgba(248, 249, 250, 0.9);
        border-radius: 15px;
        padding: 2rem;
        border: 1px solid rgba(0, 123, 255, 0.1);
        transition: all 0.3s ease;
    }

    .info-card:hover {
        background: rgba(248, 249, 250, 1);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .research-card {
        background: rgba(52, 58, 64, 0.05);
        border-radius: 15px;
        padding: 2rem;
        border: 1px solid rgba(52, 58, 64, 0.1);
        transition: all 0.3s ease;
    }

    .research-card:hover {
        background: rgba(52, 58, 64, 0.08);
        transform: translateY(-2px);
    }

    /* Process Steps */
    .process-steps {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .step-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
    }

    .step-item:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateX(5px);
    }

    .step-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(45deg, #007bff, #0056b3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    .step-content strong {
        color: #495057;
        display: block;
        margin-bottom: 0.25rem;
    }

    /* Research Metrics */
    .research-metrics {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .metric-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .metric-label {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .metric-value {
        font-weight: 600;
        color: #495057;
        font-size: 0.95rem;
    }

    .research-features {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .feature-badge {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    /* Section Titles */
    .section-title {
        color: #495057;
        font-weight: 600;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
    }

    /* Form Controls */
    .benchmark-form {
        background: rgba(248, 249, 250, 0.8);
        border-radius: 15px;
        padding: 2rem;
        border: 1px solid rgba(0, 123, 255, 0.1);
    }

    .form-floating > .form-control {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        transition: all 0.3s ease;
        font-size: 1rem;
        padding-top: 1.625rem;
        padding-bottom: 0.625rem;
    }

    .form-floating > .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
        transform: translateY(-1px);
    }

    .form-floating > label {
        color: #6c757d;
        font-weight: 500;
    }

    .form-floating > .form-control:focus ~ label,
    .form-floating > .form-control:not(:placeholder-shown) ~ label {
        color: #007bff;
    }

    .form-help {
        margin-top: 0.5rem;
    }

    /* Button Styles */
    .btn-primary {
        background: linear-gradient(45deg, #007bff, #0056b3);
        border: none;
        border-radius: 12px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .btn-primary:hover {
        background: linear-gradient(45deg, #0056b3, #004085);
        transform: translateY(-1px);
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
    }

    /* Progress Section */
    .progress-section {
        background: rgba(248, 249, 250, 0.9);
        border-radius: 15px;
        padding: 2rem;
        border: 1px solid rgba(0, 123, 255, 0.1);
        animation: fadeInUp 0.5s ease-out;
    }

    .loading-spinner {
        animation: pulse 2s infinite;
    }

    .main-progress .progress {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .main-progress .progress-bar {
        background: linear-gradient(45deg, #007bff, #0056b3);
        border-radius: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .progress-info {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }

    /* Progress Cards */
    .progress-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
        text-align: center;
        transition: all 0.3s ease;
        height: 100%;
    }

    .progress-card:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .progress-header {
        margin-bottom: 1rem;
    }

    .progress-header i {
        margin-bottom: 0.5rem;
    }

    .progress-status {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.75rem;
    }

    .progress-card .progress {
        height: 8px;
        border-radius: 4px;
    }

    /* Results Section */
    .results-section {
        animation: fadeInUp 0.6s ease-out;
    }

    /* Summary Cards */
    .summary-cards {
        margin-bottom: 3rem;
    }

    .summary-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        height: 100%;
    }

    .summary-card:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .summary-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(45deg, #007bff, #0056b3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        margin: 0 auto 1rem;
    }

    .summary-content h3 {
        font-size: 2rem;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 0.5rem;
    }

    .summary-content p {
        color: #6c757d;
        font-weight: 500;
        margin: 0;
    }

    /* Vote Distribution */
    .distribution-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 2rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* Metric Cards */
    .metric-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 1.5rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        height: 100%;
    }

    .metric-card:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    .metric-card.generation {
        border-left: 4px solid #007bff;
    }

    .metric-card.tabulation {
        border-left: 4px solid #ffc107;
    }

    .metric-card.verification {
        border-left: 4px solid #28a745;
    }

    .metric-header {
        text-align: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .metric-header i {
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .metric-header h6 {
        color: #495057;
        font-weight: 600;
        margin: 0;
    }

    .metric-body .metric-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.03);
    }

    .metric-body .metric-item:last-child {
        border-bottom: none;
    }

    .metric-body .metric-label {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }

    .metric-body .metric-value {
        font-weight: 600;
        color: #495057;
    }

    /* Comparison Table */
    .comparison-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 2rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .table-modern {
        margin: 0;
        border-radius: 10px;
        overflow: hidden;
    }

    .table-modern thead th {
        background: linear-gradient(45deg, #343a40, #495057);
        color: white;
        border: none;
        font-weight: 600;
        padding: 1rem;
    }

    .table-modern tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .table-modern tbody tr:hover {
        background: rgba(0, 123, 255, 0.02);
    }

    /* Error Section */
    .error-section {
        background: rgba(248, 249, 250, 0.9);
        border-radius: 15px;
        padding: 2rem;
        border: 1px solid rgba(220, 53, 69, 0.2);
        text-align: center;
        animation: fadeInUp 0.5s ease-out;
    }

    .error-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    .error-icon {
        color: #dc3545;
        animation: shake 1s ease-in-out;
    }

    .error-content {
        max-width: 600px;
    }

    /* Debug Section */
    .debug-section {
        background: rgba(52, 58, 64, 0.05);
        border-radius: 15px;
        padding: 1.5rem;
        border: 1px solid rgba(52, 58, 64, 0.1);
        margin-top: 2rem;
    }

    .debug-title {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .debug-content {
        background: rgba(52, 58, 64, 0.8);
        color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin: 0;
        font-size: 0.85rem;
        max-height: 300px;
        overflow-y: auto;
    }

    /* Animations */
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    @keyframes fadeInUp {
        0% { opacity: 0; transform: translateY(30px); }
        100% { opacity: 1; transform: translateY(0); }
    }

    /* Responsive Design */
    @media (max-width: 992px) {
        .benchmark-container {
            padding: 1rem 0;
        }

        .benchmark-card {
            margin: 1rem 0;
            padding: 2rem 1.5rem;
        }

        .process-steps {
            gap: 1rem;
        }

        .step-item {
            flex-direction: column;
            text-align: center;
            padding: 1.5rem;
        }

        .step-icon {
            margin-bottom: 1rem;
        }
    }

    @media (max-width: 768px) {
        .benchmark-card {
            padding: 1.5rem 1rem;
        }

        .info-card,
        .research-card,
        .benchmark-form {
            padding: 1.5rem;
        }

        .summary-card,
        .metric-card {
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .summary-icon {
            width: 50px;
            height: 50px;
            font-size: 1.25rem;
        }

        .summary-content h3 {
            font-size: 1.5rem;
        }

        .research-features {
            justify-content: center;
        }

        .progress-info {
            flex-direction: column;
            gap: 0.5rem;
        }
    }

    @media (max-width: 576px) {
        .benchmark-container {
            padding: 0.5rem 0;
        }

        .benchmark-card {
            margin: 0.5rem;
            padding: 1rem;
        }

        h1 {
            font-size: 1.75rem;
        }

        .section-title {
            font-size: 1.1rem;
        }

        .table-responsive {
            font-size: 0.85rem;
        }
    }

    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
        .benchmark-card,
        .info-card,
        .research-card,
        .summary-card,
        .metric-card,
        .progress-card,
        .btn-primary,
        .benchmark-icon,
        .loading-spinner {
            animation: none;
            transition: none;
        }
    }

    /* Focus Indicators */
    .form-control:focus,
    .btn:focus {
        outline: 2px solid #007bff;
        outline-offset: 2px;
    }

    /* High Contrast Mode */
    @media (prefers-contrast: high) {
        .benchmark-card {
            background: white;
            border: 2px solid black;
        }

        .form-control {
            border: 2px solid black;
        }

        .summary-card,
        .metric-card,
        .progress-card {
            border: 1px solid black;
        }
    }

    /* Utility Classes */
    .progress-sm {
        height: 8px;
    }

    .text-gradient {
        background: linear-gradient(45deg, #007bff, #0056b3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
</style>
{% endblock %}
{% extends "base.html" %}

{% block title %}Vote{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">
        Vote for
        {% if voting_stage == 'senat' %}
            Ketua Senat
        {% else %}
            Ketua Dewan Musyawarah Taruna
        {% endif %}
    </h1>
    {% if no_candidates %}
        <div class="text-center">
            <img src="{{ url_for('static', filename='Unknown.png') }}" alt="No Candidates" class="img-fluid mb-3">
            <p class="lead">The admin has not input any candidate. Contact your admin</p>
        </div>
    {% else %}
        <form method="post" action="{{ url_for('vote') }}" onsubmit="return validateForm()">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="voting_stage" value="{{ voting_stage }}">

            <div class="form-group mb-3">
                <label for="candidate">Choose Candidate:</label>
                <select id="candidate" name="candidate" class="form-control" onchange="updateCandidatePhoto()" required>
                    {% for candidate in candidates %}
                        <option value="{{ candidate.id }}" data-photo="{{ url_for('static', filename=candidate.photo) }}" data-name="{{ candidate.name | e }}" data-class="{{ candidate.class | e }}">{{ candidate.name | e }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary w-100">Vote</button>
        </form>
        <div class="candidate-photo-container text-center mt-4">
            <img id="candidate-photo" src="{{ url_for('static', filename=candidates[0].photo) }}" class="img-fluid candidate-photo" alt="Candidate" onerror="this.src='{{ url_for('static', filename='Unknown.png') }}'">
            <h5 id="candidate-name" class="mt-3">{{ candidates[0].name }}</h5>
            <p id="candidate-class">{{ candidates[0].class }}</p>
        </div>
    {% endif %}
</div>

<script>
    // ‚úÖ PERBAIKAN: Default image URL for fallback
    const defaultImageUrl = "{{ url_for('static', filename='Unknown.png') }}";

    function updateCandidatePhoto() {
        const candidateSelect = document.getElementById('candidate');
        const selectedOption = candidateSelect.options[candidateSelect.selectedIndex];
        const photoUrl = selectedOption.getAttribute('data-photo');
        const candidateName = selectedOption.getAttribute('data-name');
        const candidateClass = selectedOption.getAttribute('data-class');
        const candidatePhoto = document.getElementById('candidate-photo');
        const candidateNameElement = document.getElementById('candidate-name');
        const candidateClassElement = document.getElementById('candidate-class');

        // ‚úÖ PERBAIKAN: Set fallback image using onerror
        candidatePhoto.onerror = function() {
            console.log('‚ö†Ô∏è Image failed to load:', photoUrl, 'Using default image');
            this.src = defaultImageUrl;
            this.onerror = null; // Prevent infinite loop
        };

        candidatePhoto.src = photoUrl;
        candidateNameElement.textContent = candidateName;
        candidateClassElement.textContent = candidateClass;
    }

    // ‚úÖ PERBAIKAN: Enhanced image preloading and validation
    function preloadAndValidateImage(imageUrl) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(imageUrl);
            img.onerror = () => {
                console.log('‚ö†Ô∏è Image not found:', imageUrl, 'Using default');
                resolve(defaultImageUrl);
            };
            img.src = imageUrl;
        });
    }

    // ‚úÖ PERBAIKAN: Async image loading with fallback
    async function updateCandidatePhotoAsync() {
        const candidateSelect = document.getElementById('candidate');
        const selectedOption = candidateSelect.options[candidateSelect.selectedIndex];
        const photoUrl = selectedOption.getAttribute('data-photo');
        const candidateName = selectedOption.getAttribute('data-name');
        const candidateClass = selectedOption.getAttribute('data-class');
        const candidatePhoto = document.getElementById('candidate-photo');
        const candidateNameElement = document.getElementById('candidate-name');
        const candidateClassElement = document.getElementById('candidate-class');

        try {
            // Preload and validate image
            const validImageUrl = await preloadAndValidateImage(photoUrl);
            candidatePhoto.src = validImageUrl;
        } catch (error) {
            console.error('‚ùå Error loading image:', error);
            candidatePhoto.src = defaultImageUrl;
        }

        candidateNameElement.textContent = candidateName;
        candidateClassElement.textContent = candidateClass;
    }

    function validateForm() {
        const candidate = document.getElementById('candidate').value;

        const invalidChars = /[;'"<>]/;
        if (invalidChars.test(candidate)) {
            alert('Invalid characters detected in input.');
            return false;
        }

        if (!candidate) {
            alert("Please choose a candidate.");
            return false;
        }
        return true;
    }

    // ‚úÖ PERBAIKAN: Enhanced initialization with image validation
    window.onload = async function() {
        console.log('üöÄ Initializing vote page...');

        // Set default fallback for initial image
        const initialPhoto = document.getElementById('candidate-photo');
        if (initialPhoto) {
            initialPhoto.onerror = function() {
                console.log('‚ö†Ô∏è Initial image failed to load, using default');
                this.src = defaultImageUrl;
                this.onerror = null;
            };
        }

        // Update candidate photo display
        await updateCandidatePhotoAsync();

        console.log('‚úÖ Vote page initialized successfully');
    };

    // ‚úÖ PERBAIKAN: Add global error handler for all images
    document.addEventListener('DOMContentLoaded', function() {
        // Set fallback for any image that fails to load
        document.addEventListener('error', function(e) {
            if (e.target.tagName === 'IMG' && e.target.classList.contains('candidate-photo')) {
                console.log('‚ö†Ô∏è Candidate image failed to load:', e.target.src);
                e.target.src = defaultImageUrl;
            }
        }, true);
    });
</script>

<style>
    .candidate-photo {
        width: 300px;
        height: 300px;
        object-fit: cover;
        border: 2px solid #ddd;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    /* ‚úÖ NEW: Loading state styling */
    .candidate-photo:not([src]) {
        background: #f0f0f0 url('{{ url_for('static', filename='Unknown.png') }}') center/cover no-repeat;
    }

    .candidate-photo:hover {
        transform: scale(1.02);
        border-color: #007bff;
        box-shadow: 0 4px 8px rgba(0,123,255,0.3);
    }

    /* ‚úÖ NEW: Error state styling */
    .candidate-photo[src*="Unknown.png"] {
        border-color: #ffc107;
        background-color: #fff3cd;
    }
</style>
{% endblock %}